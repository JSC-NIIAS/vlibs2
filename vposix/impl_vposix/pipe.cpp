#include "pipe.h"

using namespace impl_vposix;

//=======================================================================================
pipe::pipe()
{
    int pp[2];
    wrap_unistd::pipe2( pp );

    _read  = pp[ 0 ];
    _write = pp[ 1 ];
}
//=======================================================================================
pipe::~pipe()
{}
//=======================================================================================
void pipe::close_read()
{
    _read.close();
}
//=======================================================================================
void pipe::close_write()
{
    _write.close();
}
//=======================================================================================
void pipe::dup_read( int h )
{
    wrap_unistd::dup2( _read, h );
}
//=======================================================================================
void pipe::dup_write( int h )
{
    wrap_unistd::dup2( _write, h );
}
//=======================================================================================
std::string pipe::do_read()
{
    return _read.has() ? wrap_unistd::read(_read) : std::string{};
}
//=======================================================================================
void pipe::on_events( epoll_receiver::events e )
{
    if ( e.take_read() )
        has_read( do_read() );

    if ( e.take_hang_up() )
    {
        read_has_closed();
        _read.close();
    }

    e.check_empty();
}
//=======================================================================================
void pipe::write( const std::string& data )
{
    wrap_unistd::write( _write, data );
}
//=======================================================================================
void pipe::poll_read()
{
    _read.poll_add_read( this );
}
//=======================================================================================
